<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–ü–æ—Å—Ç —É –ó–∞–º–∫–∞ ‚Äî –î–æ–∑–æ—Ä</title>
  <style>
    :root{
      --bg0:#07070b;
      --bg1:#0b1020;
      --stroke: rgba(255,255,255,.14);
      --shadow: 0 20px 70px rgba(0,0,0,.55);
      --shadow2: 0 10px 30px rgba(0,0,0,.45);
      --danger:#ff4d6d;
      --ok:#3dffb5;
      --gold:#ffd27c;
      --text:#eaf0ff;
    }
    *{ box-sizing:border-box; }
    html,body{
      height:100%; margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--text);
      background: radial-gradient(1200px 600px at 50% 30%, #1a2452 0%, var(--bg1) 45%, var(--bg0) 100%);
      overflow:hidden;
    }
    body::before{
      content:"";
      position:fixed; inset:-20%;
      background:
        radial-gradient(1px 1px at 10% 20%, rgba(255,255,255,.45) 0 1px, transparent 2px),
        radial-gradient(1px 1px at 20% 80%, rgba(255,255,255,.35) 0 1px, transparent 2px),
        radial-gradient(1px 1px at 35% 35%, rgba(255,255,255,.30) 0 1px, transparent 2px),
        radial-gradient(1px 1px at 60% 15%, rgba(255,255,255,.40) 0 1px, transparent 2px),
        radial-gradient(1px 1px at 80% 65%, rgba(255,255,255,.25) 0 1px, transparent 2px),
        radial-gradient(1px 1px at 85% 30%, rgba(255,255,255,.35) 0 1px, transparent 2px),
        radial-gradient(1px 1px at 55% 85%, rgba(255,255,255,.22) 0 1px, transparent 2px);
      opacity:.55;
      filter: blur(.2px);
      animation: drift 20s linear infinite;
      pointer-events:none;
    }
    @keyframes drift{ to{ transform: translate3d(-3%,2%,0) scale(1.02);} }

    .wrap{
      position:relative;
      height:100%;
      display:grid;
      grid-template-columns: 1.15fr .85fr;
      gap:18px;
      padding:18px;
    }
    .card{
      border-radius:22px;
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      border:1px solid var(--stroke);
      box-shadow: var(--shadow2);
      overflow:hidden;
    }

    /* Scene */
    .scene{
      position:relative;
      border-radius:22px;
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
      border:1px solid var(--stroke);
      box-shadow: var(--shadow);
      overflow:hidden;
      min-height: 520px;
    }
    .scene::before{
      content:"";
      position:absolute; inset:0;
      background:
        radial-gradient(900px 500px at 50% 60%, rgba(124,247,255,.16) 0%, rgba(180,140,255,.10) 35%, transparent 70%),
        radial-gradient(600px 300px at 15% 75%, rgba(255,210,124,.08) 0%, transparent 65%),
        radial-gradient(700px 400px at 90% 80%, rgba(255,77,109,.08) 0%, transparent 65%);
      pointer-events:none;
      mix-blend-mode: screen;
      opacity:.85;
    }
    .fog{
      position:absolute; left:-10%; right:-10%; bottom:-20%;
      height:55%;
      background: radial-gradient(60% 60% at 50% 40%, rgba(255,255,255,.10) 0%, rgba(255,255,255,.04) 45%, transparent 75%);
      filter: blur(8px);
      opacity:.55;
      animation: fogMove 12s ease-in-out infinite alternate;
      pointer-events:none;
    }
    .fog.f2{ bottom:-25%; opacity:.35; filter: blur(14px); animation-duration: 18s; }
    @keyframes fogMove{ to{ transform: translateX(2%) translateY(-1%);} }

    .ground{
      position:absolute; left:0; right:0; bottom:0;
      height:42%;
      background:
        linear-gradient(180deg, transparent 0%, rgba(0,0,0,.25) 15%, rgba(0,0,0,.55) 45%, rgba(0,0,0,.88) 100%),
        radial-gradient(80% 120% at 50% 20%, rgba(180,140,255,.18) 0%, rgba(124,247,255,.08) 35%, transparent 70%);
    }
    .road{
      position:absolute; left:50%; bottom:-5%;
      width:52%;
      height:60%;
      transform: translateX(-50%) perspective(600px) rotateX(55deg);
      background: linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.10);
      border-top:none;
      border-radius: 14px;
      box-shadow: inset 0 0 60px rgba(0,0,0,.55);
      mask-image: radial-gradient(80% 65% at 50% 10%, rgba(0,0,0,1) 0%, rgba(0,0,0,.9) 40%, transparent 80%);
    }

    /* Enemy - NO labels */
    .enemy{
      position:absolute;
      left: 8%;
      bottom: 21%;
      width: 190px;
      height: 190px;
      border-radius: 22px;
      border:1px solid rgba(255,255,255,.18);
      background: linear-gradient(145deg, rgba(255,255,255,.10), rgba(255,255,255,.03));
      box-shadow: 0 18px 60px rgba(0,0,0,.65);
      display:grid;
      place-items:center;
      opacity:0;
      transform: translateX(-40px) scale(.9);
      pointer-events:none;
    }
    .enemy.active{
      opacity:1;
      animation: march 20s linear forwards;
      pointer-events:auto;
    }
    @keyframes march{
      0%   { left: 8%;   transform: translateX(0) scale(.86);  filter: blur(.15px); }
      60%  { left: 48%;  transform: translateX(0) scale(1.0);  filter: blur(0px); }
      100% { left: 76%;  transform: translateX(0) scale(1.18); filter: blur(0px); }
    }
    .enemyBadge{
      width: 92%;
      height: 92%;
      border-radius: 18px;
      display:grid;
      place-items:center;
      position:relative;
      overflow:hidden;
    }
    .enemyBadge::before{
      content:"";
      position:absolute; inset:-45%;
      background: conic-gradient(from 90deg, rgba(124,247,255,.0), rgba(124,247,255,.26), rgba(180,140,255,.26), rgba(255,210,124,.18), rgba(255,77,109,.20), rgba(124,247,255,.0));
      animation: spin 6s linear infinite;
      opacity:.85;
      filter: blur(12px);
    }
    @keyframes spin{ to{ transform: rotate(360deg); } }
    .enemyInner{
      position:relative;
      width: 100%;
      height: 100%;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.14);
      background:
        radial-gradient(120px 120px at 30% 20%, rgba(124,247,255,.18), transparent 60%),
        radial-gradient(160px 160px at 80% 70%, rgba(180,140,255,.16), transparent 60%),
        linear-gradient(180deg, rgba(0,0,0,.15), rgba(0,0,0,.48));
      display:grid;
      place-items:center;
      box-shadow: inset 0 0 60px rgba(0,0,0,.55);
      padding: 10px;
    }
    .enemyArt{
      width: 100%;
      height: 100%;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.05);
      display:grid;
      place-items:center;
      overflow:hidden;
      box-shadow: inset 0 0 35px rgba(0,0,0,.45);
      position:relative;
    }
    .enemyArt::after{
      content:"";
      position:absolute; inset:-10%;
      background: radial-gradient(55% 45% at 50% 20%, rgba(255,255,255,.10) 0%, transparent 55%);
      pointer-events:none;
      mix-blend-mode: screen;
      opacity:.75;
    }
    .enemyArt svg{
      width: 96%;
      height: 96%;
      filter: drop-shadow(0 12px 22px rgba(0,0,0,.55));
    }

    /* Castle */
    .castle{
      position:absolute; left:50%; bottom:16%;
      transform: translateX(-50%);
      width:min(560px, 82%);
      height:46%;
      filter: drop-shadow(0 18px 35px rgba(0,0,0,.65));
      opacity:.95;
    }

    /* HUD */
    .hud{
      display:grid;
      grid-template-rows: auto auto 1fr;
      gap:12px;
      min-height: 520px;
    }
    .topbar{
      padding:14px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .brand{ display:flex; align-items:center; gap:10px; }
    .orb{
      width:34px; height:34px; border-radius: 12px;
      background: radial-gradient(circle at 30% 30%, rgba(124,247,255,.9), rgba(180,140,255,.35) 45%, rgba(0,0,0,.1) 70%);
      box-shadow: 0 0 30px rgba(124,247,255,.25), 0 0 40px rgba(180,140,255,.18);
      border:1px solid rgba(255,255,255,.18);
    }
    .titleBlock{ line-height:1.1; }
    .titleBlock .t1{ font-size:14px; opacity:.78; }
    .titleBlock .t2{ font-size:16px; font-weight:900; letter-spacing:.3px; }

    .chipRow{ display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; }
    .chip{
      padding:8px 10px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.18);
      backdrop-filter: blur(10px);
      font-size:12px;
      display:flex; gap:8px; align-items:center;
    }
    .dot{ width:8px; height:8px; border-radius:50%; background: rgba(255,255,255,.25); box-shadow: 0 0 0 6px rgba(255,255,255,.05); }
    .dot.ok{ background: var(--ok); box-shadow: 0 0 0 6px rgba(61,255,181,.12); }
    .dot.bad{ background: var(--danger); box-shadow: 0 0 0 6px rgba(255,77,109,.12); }
    .dot.pause{ background: var(--gold); box-shadow: 0 0 0 6px rgba(255,210,124,.12); }

    .panel{ padding:14px 16px 16px; }
    .big{ font-size: 30px; font-weight: 950; letter-spacing: .4px; margin: 6px 0 2px; }
    .sub{ font-size: 13px; opacity: .75; }
    .divider{ height:1px; background: linear-gradient(90deg, transparent, rgba(255,255,255,.14), transparent); margin: 12px 0; }

    .row{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    label{ display:block; font-size: 12px; opacity:.78; margin-bottom:6px; }

    select, input[type="text"]{
      width:100%;
      padding:12px 12px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.24);
      color:#eaf0ff;
      outline:none;
      box-shadow: inset 0 0 30px rgba(0,0,0,.35);
    }

    .actions{ display:flex; gap:10px; flex-wrap:wrap; margin-top: 12px; align-items:center; }

    button{
      padding:12px 14px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.16);
      background: linear-gradient(180deg, rgba(124,247,255,.18), rgba(180,140,255,.10));
      color:#f5fbff;
      font-weight: 900;
      letter-spacing:.2px;
      cursor:pointer;
      box-shadow: 0 18px 50px rgba(124,247,255,.12);
      transition: transform .15s ease, filter .15s ease;
      user-select:none;
    }
    button:hover{ transform: translateY(-1px); filter: brightness(1.08); }
    button:active{ transform: translateY(1px); filter: brightness(.98); }
    .btnGhost{ background: rgba(0,0,0,.18); box-shadow:none; }

    .status{
      margin-top: 10px;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22);
      padding: 12px 12px;
      display:grid;
      gap:8px;
    }
    .statusLine{ display:flex; align-items:center; justify-content:space-between; gap:10px; font-size: 13px; }
    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      padding: 3px 8px;
      border-radius: 10px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
    }
    .progress{ height: 10px; border-radius: 999px; border:1px solid rgba(255,255,255,.12); background: rgba(255,255,255,.06); overflow:hidden; }
    .bar{
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, rgba(255,77,109,.75), rgba(255,210,124,.75), rgba(124,247,255,.70));
      filter: saturate(1.2);
      box-shadow: 0 0 25px rgba(255,77,109,.18);
      transition: width .08s linear;
    }

    /* Codex */
    .codex{ padding: 12px 16px 16px; max-height: 330px; overflow:auto; }
    .codex h3{ margin:0 0 10px; font-size:13px; letter-spacing:.4px; opacity:.85; }
    .codexGrid{ display:grid; grid-template-columns: 1fr; gap:10px; }
    .codexItem{
      display:grid;
      grid-template-columns: 84px 1fr;
      gap:10px;
      align-items:center;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.16);
      padding: 10px;
    }
    .codexArt{
      width:84px; height:84px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      display:grid;
      place-items:center;
      box-shadow: inset 0 0 24px rgba(0,0,0,.35);
      overflow:hidden;
    }
    .codexArt svg{ width: 92%; height: 92%; }
    .codexName{ font-weight: 900; font-size: 13px; margin-bottom: 4px; }
    .codexText{ font-size: 12px; opacity:.76; line-height: 1.35; }

    /* Log */
    .log{ max-height: 260px; overflow:auto; padding: 12px 16px 16px; }
    .log h3{ margin: 0 0 8px; font-size: 13px; letter-spacing:.4px; opacity:.85; }
    .entry{
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      padding: 10px 12px;
      margin: 10px 0;
      display:grid;
      gap:6px;
      box-shadow: inset 0 0 25px rgba(0,0,0,.35);
    }
    .entryTop{ display:flex; justify-content:space-between; gap:10px; font-size: 12px; opacity: .82; }
    .pill{ padding: 3px 8px; border-radius: 999px; border:1px solid rgba(255,255,255,.14); background: rgba(255,255,255,.06); width: fit-content; font-size: 12px; }
    .pill.ok{ border-color: rgba(61,255,181,.30); background: rgba(61,255,181,.10); }
    .pill.bad{ border-color: rgba(255,77,109,.30); background: rgba(255,77,109,.10); }

    /* Toast */
    .toast{
      position:absolute;
      left:50%;
      top:16px;
      transform: translateX(-50%) translateY(-12px);
      padding:10px 12px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.35);
      backdrop-filter: blur(12px);
      box-shadow: var(--shadow2);
      opacity:0;
      pointer-events:none;
      transition: opacity .18s ease, transform .18s ease;
      font-size: 13px;
      display:flex;
      align-items:center;
      gap:10px;
      z-index: 50;
      max-width: min(620px, 92%);
    }
    .toast.show{ opacity:1; transform: translateX(-50%) translateY(0); }
    .toast .spark{
      width:10px; height:10px; border-radius: 50%;
      background: rgba(124,247,255,.95);
      box-shadow: 0 0 0 6px rgba(124,247,255,.10), 0 0 22px rgba(124,247,255,.22);
    }

    canvas#fx{ position:absolute; inset:0; pointer-events:none; opacity:.9; }

    /* Start overlay (audio required) */
    .overlay{
      position:fixed; inset:0;
      background: radial-gradient(900px 600px at 50% 40%, rgba(124,247,255,.10), rgba(0,0,0,.82) 55%, rgba(0,0,0,.92) 100%);
      display:grid;
      place-items:center;
      z-index: 1000;
      padding: 18px;
    }
    .overlayBox{
      width: min(560px, 96%);
      border-radius: 24px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.35);
      backdrop-filter: blur(16px);
      box-shadow: var(--shadow);
      padding: 18px;
    }
    .overlayTitle{ font-weight: 950; font-size: 22px; letter-spacing:.3px; margin: 0 0 8px; }
    .overlayText{ opacity:.78; font-size: 13px; line-height:1.45; margin: 0 0 14px; }
    .muted{ opacity:.72; }
  </style>
</head>
<body>
  <div class="overlay" id="overlay">
    <div class="overlayBox">
      <div class="overlayTitle">–ü–æ—Å—Ç —É –ó–∞–º–∫–∞</div>
      <p class="overlayText">
        –ü—Ä–∞–≤–∏–ª–∞ —Ç—Ä–µ–≤–æ–≥–∏: <b>–∑–∞ 20 —Å–µ–∫—É–Ω–¥</b> –ø–æ–¥–∞–π –æ—Ç—á—ë—Ç (–≤—ã–±–µ—Ä–∏ —Ç–∏–ø 1‚Äì10 ‚Üí ¬´–ü–æ–¥–∞—Ç—å –æ—Ç—á—ë—Ç¬ª), –∑–∞—Ç–µ–º <b>–ü–†–û–ë–ï–õ</b> ‚Äî –≥–æ—Ä–Ω.
        <br><span class="muted">–ü–∞—É–∑–∞: <span class="kbd">P</span>. –ï—Å–ª–∏ –≤–∫–ª–∞–¥–∫–∞ –Ω–µ –∞–∫—Ç–∏–≤–Ω–∞ ‚Äî –≤—Ä–µ–º—è –Ω–µ –∏–¥—ë—Ç. –ó–≤—É–∫ –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω.</span>
      </p>
      <button id="btnStart">‚ñ∂Ô∏è –°–¢–ê–†–¢</button>
    </div>
  </div>

  <div class="wrap">
    <section class="scene card">
      <canvas id="fx"></canvas>

      <div class="toast" id="toast">
        <div class="spark"></div>
        <div id="toastText">‚Ä¶</div>
      </div>

      <!-- Enemy: ONLY picture -->
      <div class="enemy" id="enemy">
        <div class="enemyBadge">
          <div class="enemyInner">
            <div class="enemyArt" id="enemyArt"></div>
          </div>
        </div>
      </div>

      <!-- Castle SVG -->
      <svg class="castle" viewBox="0 0 900 520" fill="none" xmlns="http://www.w3.org/2000/svg">
        <defs>
          <linearGradient id="g" x1="450" y1="60" x2="450" y2="520" gradientUnits="userSpaceOnUse">
            <stop stop-color="rgba(255,255,255,.16)"/>
            <stop offset="1" stop-color="rgba(255,255,255,.04)"/>
          </linearGradient>
          <linearGradient id="g2" x1="450" y1="60" x2="450" y2="520" gradientUnits="userSpaceOnUse">
            <stop stop-color="rgba(124,247,255,.16)"/>
            <stop offset="1" stop-color="rgba(180,140,255,.08)"/>
          </linearGradient>
          <filter id="glow" x="-50%" y="-50%" width="200%" height="200%">
            <feGaussianBlur stdDeviation="8" result="blur"/>
            <feColorMatrix in="blur" type="matrix"
              values="1 0 0 0 0
                      0 1 0 0 0
                      0 0 1 0 0
                      0 0 0 0.55 0"/>
            <feMerge><feMergeNode/><feMergeNode in="SourceGraphic"/></feMerge>
          </filter>
        </defs>
        <path d="M180 480V250L240 200V140L290 90H355V140L390 170V260H510V170L545 140V90H610L660 140V200L720 250V480H180Z"
              fill="url(#g2)" opacity="0.35" filter="url(#glow)"/>
        <path d="M190 480V260L250 210V150L300 100H360V150L395 180V270H505V180L540 150V100H600L650 150V210L710 260V480H190Z"
              fill="url(#g)" stroke="rgba(255,255,255,.16)" stroke-width="2"/>
        <path d="M280 150V120H305V150H330V120H355V150H280Z" fill="rgba(255,255,255,.12)"/>
        <path d="M545 150V120H570V150H595V120H620V150H545Z" fill="rgba(255,255,255,.12)"/>
        <path d="M410 480V330C410 300 435 275 465 275H475C505 275 530 300 530 330V480H410Z"
              fill="rgba(0,0,0,.35)" stroke="rgba(255,255,255,.14)" stroke-width="2"/>
        <rect x="335" y="240" width="26" height="46" rx="13" fill="rgba(255,210,124,.25)" stroke="rgba(255,255,255,.12)"/>
        <rect x="540" y="240" width="26" height="46" rx="13" fill="rgba(255,210,124,.20)" stroke="rgba(255,255,255,.12)"/>
      </svg>

      <div class="ground"></div>
      <div class="road"></div>
      <div class="fog"></div>
      <div class="fog f2"></div>
    </section>

    <aside class="hud">
      <div class="card topbar">
        <div class="brand">
          <div class="orb"></div>
          <div class="titleBlock">
            <div class="t1">–î–æ–∑–æ—Ä–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å</div>
            <div class="t2">–ü–æ—Å—Ç —É –ó–∞–º–∫–∞</div>
          </div>
        </div>
        <div class="chipRow">
          <div class="chip"><span class="dot ok" id="dotState"></span><span id="stateLabel">–¢–∏—à–∏–Ω–∞</span></div>
          <div class="chip">‚è±Ô∏è <b id="survival">00:00</b></div>
          <div class="chip">üèÖ <b id="streak">0</b></div>
        </div>
      </div>

      <div class="card panel">
        <div class="sub">–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è</div>
        <div class="big" id="alarmTitle">–¢–∏—à–∏–Ω–∞ –Ω–∞ —Ç—Ä–∞–∫—Ç–µ</div>
        <div class="sub" id="alarmSub">–í—Ä–µ–º—è –¥–æ –ø–æ—è–≤–ª–µ–Ω–∏—è —Å–∫—Ä—ã—Ç–æ.</div>

        <div class="divider"></div>

        <div class="row">
          <div>
            <label for="typeSelect">–û—Ç—á—ë—Ç: –≤—ã–±—Ä–∞—Ç—å —Ç–∏–ø –≤—Ä–∞–≥–∞</label>
            <select id="typeSelect"></select>
          </div>
          <div>
            <label for="note">–ó–∞–º–µ—Ç–∫–∞ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
            <input id="note" type="text" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: '–∏–¥—ë—Ç –±—ã—Å—Ç—Ä–æ'"/>
          </div>
        </div>

        <div class="actions">
          <button id="btnSubmit">üìú –ü–æ–¥–∞—Ç—å –æ—Ç—á—ë—Ç</button>
          <button class="btnGhost" id="btnPause">‚è∏Ô∏è –ü–∞—É–∑–∞ (P)</button>
          <button class="btnGhost" id="btnReset">üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫</button>
          <span class="muted">–ì–æ—Ä–Ω: <span class="kbd">–ü—Ä–æ–±–µ–ª</span></span>
        </div>

        <div class="status">
          <div class="statusLine">
            <span>–û—Å—Ç–∞–ª–æ—Å—å (20 —Å–µ–∫—É–Ω–¥)</span>
            <b id="remain">‚Äî</b>
          </div>
          <div class="progress"><div class="bar" id="bar"></div></div>
          <div class="statusLine muted">
            <span>–°–æ—Å—Ç–æ—è–Ω–∏–µ</span>
            <span id="hint">–ñ–¥–∏ –∫–æ–Ω—Ç–∞–∫—Ç–∞</span>
          </div>
        </div>
      </div>

      <div class="card codex">
        <h3>–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ —Ä–∞–∑–ª–∏—á–∏–π (–¢–ò–ü–´ 1‚Äì10)</h3>
        <div class="codexGrid" id="codexGrid"></div>
      </div>

      <div class="card log">
        <h3>–ñ—É—Ä–Ω–∞–ª</h3>
        <div id="log"></div>
      </div>
    </aside>
  </div>

<script>
(() => {
  // ---------- helpers ----------
  const pad2 = n => String(n).padStart(2,'0');
  const clamp = (v,a,b)=>Math.max(a,Math.min(b,v));
  function fmtTime(ms){
    ms = Math.max(0, ms);
    const s = Math.floor(ms/1000);
    const m = Math.floor(s/60);
    const r = s%60;
    return `${pad2(m)}:${pad2(r)}`;
  }
  function rndInt(min, max){ return Math.floor(Math.random()*(max-min+1))+min; }
  function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
  function escapeHtml(s){
    return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[c]));
  }

  // ---------- FX particles ----------
  const canvas = document.getElementById('fx');
  const ctxFx = canvas.getContext('2d');
  let W=0,H=0,DPR=1;
  function resize(){
    DPR = Math.min(2, window.devicePixelRatio || 1);
    W = canvas.clientWidth = canvas.parentElement.clientWidth;
    H = canvas.clientHeight = canvas.parentElement.clientHeight;
    canvas.width = Math.floor(W * DPR);
    canvas.height = Math.floor(H * DPR);
    ctxFx.setTransform(DPR,0,0,DPR,0,0);
  }
  window.addEventListener('resize', resize);

  const particles = [];
  function spawnParticles(n, intensity=1){
    for(let i=0;i<n;i++){
      particles.push({
        x: Math.random()*W,
        y: Math.random()*H,
        vx: (Math.random()-.5)*0.22*intensity,
        vy: (0.12+Math.random()*0.42)*intensity,
        r: (1+Math.random()*2.4)*intensity,
        a: 0.08+Math.random()*0.18,
        life: 80+Math.random()*220,
        hue: 175+Math.random()*115,
      });
    }
  }
  function pulse(mult){ spawnParticles(34, mult); }

  function fxLoop(){
    ctxFx.clearRect(0,0,W,H);
    const g = ctxFx.createRadialGradient(W/2,H/2, 80, W/2,H/2, Math.max(W,H)*0.65);
    g.addColorStop(0, 'rgba(0,0,0,0)');
    g.addColorStop(1, 'rgba(0,0,0,0.35)');
    ctxFx.fillStyle = g;
    ctxFx.fillRect(0,0,W,H);

    for(let i=particles.length-1;i>=0;i--){
      const p = particles[i];
      p.x += p.vx; p.y += p.vy; p.life -= 1;
      if(p.y > H+10) p.y = -10;
      if(p.x < -10) p.x = W+10;
      if(p.x > W+10) p.x = -10;

      const alpha = p.a * Math.min(1, p.life/60);
      ctxFx.beginPath();
      ctxFx.fillStyle = `hsla(${p.hue}, 90%, 70%, ${alpha})`;
      ctxFx.arc(p.x, p.y, p.r, 0, Math.PI*2);
      ctxFx.fill();

      if(p.life <= 0) particles.splice(i,1);
    }
    if(particles.length < 90 && Math.random() < 0.25) spawnParticles(2, 1);
    requestAnimationFrame(fxLoop);
  }

  resize();
  spawnParticles(80,1);
  fxLoop();

  // ---------- Audio (MANDATORY) ----------
  const audio = (() => {
    let ctx=null, master=null, musicGain=null, stepGain=null;
    let running=false;

    let musicOsc1, musicOsc2, musicLfo, musicFilter, musicNoise, musicNoiseFilter;
    let stepNoise, stepFilter, stepPulse;
    let intensity = 1.0;
    let footstepsOn = false;
    let stepTimer = null;

    function ensure(){
      if(ctx) return;
      ctx = new (window.AudioContext || window.webkitAudioContext)();

      master = ctx.createGain();
      master.gain.value = 0.55;
      master.connect(ctx.destination);

      musicGain = ctx.createGain();
      musicGain.gain.value = 0.35;
      musicGain.connect(master);

      stepGain = ctx.createGain();
      stepGain.gain.value = 0.0;
      stepGain.connect(master);
    }

    function makeNoise(){
      const bufferSize = 2 * ctx.sampleRate;
      const buffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
      const data = buffer.getChannelData(0);
      for(let i=0;i<bufferSize;i++) data[i] = (Math.random()*2-1) * 0.55;
      const src = ctx.createBufferSource();
      src.buffer = buffer;
      src.loop = true;
      return src;
    }

    function startMusic(){
      musicFilter = ctx.createBiquadFilter();
      musicFilter.type = 'lowpass';
      musicFilter.frequency.value = 520;
      musicFilter.Q.value = 0.85;

      const post = ctx.createGain();
      post.gain.value = 0.9;

      musicOsc1 = ctx.createOscillator();
      musicOsc2 = ctx.createOscillator();
      musicOsc1.type = 'sawtooth';
      musicOsc2.type = 'sawtooth';

      musicOsc1.frequency.value = 110;
      musicOsc2.frequency.value = 110 * 1.498;

      const det1 = ctx.createGain(); det1.gain.value = 0.55;
      const det2 = ctx.createGain(); det2.gain.value = 0.48;

      musicOsc1.connect(det1);
      musicOsc2.connect(det2);

      const mix = ctx.createGain();
      det1.connect(mix);
      det2.connect(mix);

      musicLfo = ctx.createOscillator();
      musicLfo.type = 'sine';
      musicLfo.frequency.value = 0.25;
      const lfoGain = ctx.createGain();
      lfoGain.gain.value = 0.12;
      musicLfo.connect(lfoGain);
      lfoGain.connect(post.gain);

      mix.connect(musicFilter);
      musicFilter.connect(post);
      post.connect(musicGain);

      musicNoise = makeNoise();
      musicNoiseFilter = ctx.createBiquadFilter();
      musicNoiseFilter.type = 'bandpass';
      musicNoiseFilter.frequency.value = 220;
      musicNoiseFilter.Q.value = 0.7;

      const noiseGain = ctx.createGain();
      noiseGain.gain.value = 0.06;

      musicNoise.connect(musicNoiseFilter);
      musicNoiseFilter.connect(noiseGain);
      noiseGain.connect(musicGain);

      musicOsc1.start();
      musicOsc2.start();
      musicLfo.start();
      musicNoise.start();
    }

    function startFootsteps(){
      stepNoise = makeNoise();
      stepFilter = ctx.createBiquadFilter();
      stepFilter.type = 'lowpass';
      stepFilter.frequency.value = 280;
      stepFilter.Q.value = 0.8;

      stepPulse = ctx.createGain();
      stepPulse.gain.value = 0.0;

      stepNoise.connect(stepFilter);
      stepFilter.connect(stepPulse);
      stepPulse.connect(stepGain);

      stepNoise.start();
    }

    function scheduleStep(){
      if(!ctx || !footstepsOn) return;
      const t = ctx.currentTime;
      const g = stepPulse.gain;
      const base = 0.10 * intensity;
      const bump = 0.22 * intensity;
      g.cancelScheduledValues(t);
      g.setValueAtTime(0.0, t);
      g.linearRampToValueAtTime(base + bump, t + 0.02);
      g.exponentialRampToValueAtTime(base * 0.35 + 0.001, t + 0.12);
      g.linearRampToValueAtTime(0.0, t + 0.18);
    }

    function setFootsteps(on){
      footstepsOn = on;
      if(!ctx) return;
      // VERY QUIET footsteps by default:
      const target = on ? (0.10 * intensity) : 0.0;
      stepGain.gain.setTargetAtTime(target, ctx.currentTime, 0.10);

      if(on){
        if(!stepNoise) startFootsteps();
        clearInterval(stepTimer);
        stepTimer = setInterval(() => scheduleStep(), 760);
        scheduleStep();
      } else {
        clearInterval(stepTimer);
        stepTimer = null;
      }
    }

    function setIntensity(v){
      intensity = v;
      if(!ctx) return;
      musicGain.gain.setTargetAtTime(0.35 * intensity, ctx.currentTime, 0.12);
      if(footstepsOn){
        stepGain.gain.setTargetAtTime(0.10 * intensity, ctx.currentTime, 0.12);
      }
    }

    function horn(){
      if(!ctx) return;
      const t0 = ctx.currentTime;
      const g = ctx.createGain();
      g.gain.value = 0.0;

      const filt = ctx.createBiquadFilter();
      filt.type = 'bandpass';
      filt.frequency.value = 520;
      filt.Q.value = 0.9;

      g.connect(filt);
      filt.connect(master);

      const o1 = ctx.createOscillator();
      const o2 = ctx.createOscillator();
      const o3 = ctx.createOscillator();
      o1.type='sawtooth';
      o2.type='square';
      o3.type='sine';

      const base = 196;
      o1.frequency.setValueAtTime(base, t0);
      o2.frequency.setValueAtTime(base*2, t0);
      o3.frequency.setValueAtTime(base*3, t0);

      o1.frequency.exponentialRampToValueAtTime(base*0.86, t0+0.45);
      o2.frequency.exponentialRampToValueAtTime(base*1.72, t0+0.45);
      o3.frequency.exponentialRampToValueAtTime(base*2.6, t0+0.45);

      const vol = 0.52;
      g.gain.setValueAtTime(0.0, t0);
      g.gain.linearRampToValueAtTime(vol, t0+0.03);
      g.gain.exponentialRampToValueAtTime(0.001, t0+0.75);

      o1.connect(g); o2.connect(g); o3.connect(g);
      o1.start(t0); o2.start(t0); o3.start(t0);
      o1.stop(t0+0.8); o2.stop(t0+0.8); o3.stop(t0+0.8);
    }

    async function start(){
      ensure();
      if(ctx.state === 'suspended') await ctx.resume();
      if(running) return;
      running = true;
      startMusic();
      setIntensity(1.0);
    }

    return { start, setFootsteps, setIntensity, horn };
  })();

  // ---------- Enemy set: VERY similar silhouettes ----------
  // Base body + tiny "mark" differences
  function svgEnemy(markInner){
    return `
      <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
        <defs>
          <linearGradient id="s" x1="0" y1="0" x2="0" y2="1">
            <stop offset="0" stop-color="rgba(255,255,255,.14)"/>
            <stop offset="1" stop-color="rgba(255,255,255,.04)"/>
          </linearGradient>
          <filter id="sh" x="-50%" y="-50%" width="200%" height="200%">
            <feGaussianBlur stdDeviation="2.2" result="b"/>
            <feColorMatrix in="b" type="matrix"
              values="0 0 0 0 0
                      0 0 0 0 0
                      0 0 0 0 0
                      0 0 0 0.55 0"/>
            <feMerge><feMergeNode/><feMergeNode in="SourceGraphic"/></feMerge>
          </filter>
        </defs>

        <circle cx="50" cy="50" r="46" fill="rgba(124,247,255,.20)" opacity="0.35"/>
        <circle cx="50" cy="50" r="44" fill="rgba(0,0,0,.24)" stroke="rgba(255,255,255,.12)"/>

        <g filter="url(#sh)">
          <!-- base silhouette (almost identical for all) -->
          <path d="M32 82
                   Q34 60 40 52
                   Q41 36 50 32
                   Q59 36 60 52
                   Q66 60 68 82
                   Q60 80 58 72
                   Q56 64 50 64
                   Q44 64 42 72
                   Q40 80 32 82 Z"
                fill="url(#s)" stroke="rgba(255,255,255,.10)" stroke-width="1.2"/>
          <!-- tiny visor -->
          <path d="M44 34 L56 34 L54 42 L46 42 Z"
                fill="rgba(0,0,0,.22)" stroke="rgba(255,255,255,.08)" stroke-width="1.0"/>

          <!-- micro mark (difference) -->
          ${markInner}
        </g>
      </svg>
    `;
  }

  const ENEMIES = [
    { id:"t1", label:"–¢–∏–ø 1", art: svgEnemy(`<path d="M50 20 L53 24 L50 26 L47 24 Z" fill="rgba(255,255,255,.12)"/>`),
      tell:"–¢–∏–ø 1: –º–∏–∫—Ä–æ—à–∏–ø —Å–≤–µ—Ä—Ö—É –ø–æ —Ü–µ–Ω—Ç—Ä—É (–º–∞–ª–µ–Ω—å–∫–∏–π —Ä–æ–º–±)." },
    { id:"t2", label:"–¢–∏–ø 2", art: svgEnemy(`<path d="M64 48 L78 54 L76 58 L62 52 Z" fill="rgba(255,255,255,.10)"/>`),
      tell:"–¢–∏–ø 2: –∫—Ä–æ—à–µ—á–Ω—ã–π –≤—ã—Å—Ç—É–ø —Å–ø—Ä–∞–≤–∞ –Ω–∞ —É—Ä–æ–≤–Ω–µ –ø–ª–µ—á–∞." },
    { id:"t3", label:"–¢–∏–ø 3", art: svgEnemy(`<path d="M36 48 L22 54 L24 58 L38 52 Z" fill="rgba(255,255,255,.10)"/>`),
      tell:"–¢–∏–ø 3: –∫—Ä–æ—à–µ—á–Ω—ã–π –≤—ã—Å—Ç—É–ø —Å–ª–µ–≤–∞ –Ω–∞ —É—Ä–æ–≤–Ω–µ –ø–ª–µ—á–∞." },
    { id:"t4", label:"–¢–∏–ø 4", art: svgEnemy(`<path d="M58 44 L62 50" stroke="rgba(255,255,255,.14)" stroke-width="2" stroke-linecap="round"/>`),
      tell:"–¢–∏–ø 4: —Ç–æ–Ω–∫–∞—è –Ω–∞—Å–µ—á–∫–∞ —Å–ø—Ä–∞–≤–∞ (–∫–æ—Ä–æ—Ç–∫–∞—è –ª–∏–Ω–∏—è)." },
    { id:"t5", label:"–¢–∏–ø 5", art: svgEnemy(`<path d="M42 44 L38 50" stroke="rgba(255,255,255,.14)" stroke-width="2" stroke-linecap="round"/>`),
      tell:"–¢–∏–ø 5: —Ç–æ–Ω–∫–∞—è –Ω–∞—Å–µ—á–∫–∞ —Å–ª–µ–≤–∞ (–∫–æ—Ä–æ—Ç–∫–∞—è –ª–∏–Ω–∏—è)." },
    { id:"t6", label:"–¢–∏–ø 6", art: svgEnemy(`<circle cx="74" cy="26" r="2.0" fill="rgba(255,255,255,.13)"/>`),
      tell:"–¢–∏–ø 6: –æ–¥–Ω–∞ —Ç–æ—á–∫–∞ —Å–ø—Ä–∞–≤–∞ —Å–≤–µ—Ä—Ö—É (–∫–∞–∫ –∏—Å–∫—Ä–∞)." },
    { id:"t7", label:"–¢–∏–ø 7", art: svgEnemy(`<circle cx="26" cy="26" r="2.0" fill="rgba(255,255,255,.13)"/>`),
      tell:"–¢–∏–ø 7: –æ–¥–Ω–∞ —Ç–æ—á–∫–∞ —Å–ª–µ–≤–∞ —Å–≤–µ—Ä—Ö—É." },
    { id:"t8", label:"–¢–∏–ø 8", art: svgEnemy(`<path d="M50 66 L64 74 L62 78 L48 70 Z" fill="rgba(255,255,255,.09)"/>`),
      tell:"–¢–∏–ø 8: —Ç–æ–Ω–∫–∏–π –∫–ª–∏–Ω —Å–ø—Ä–∞–≤–∞ —Å–Ω–∏–∑—É (–ø–æ—á—Ç–∏ –Ω–µ–∑–∞–º–µ—Ç–Ω—ã–π)." },
    { id:"t9", label:"–¢–∏–ø 9", art: svgEnemy(`<path d="M50 66 L36 74 L38 78 L52 70 Z" fill="rgba(255,255,255,.09)"/>`),
      tell:"–¢–∏–ø 9: —Ç–æ–Ω–∫–∏–π –∫–ª–∏–Ω —Å–ª–µ–≤–∞ —Å–Ω–∏–∑—É." },
    { id:"t10", label:"–¢–∏–ø 10", art: svgEnemy(`<path d="M50 28 L52 30 L50 31 L48 30 Z" fill="rgba(255,255,255,.12)"/>`),
      tell:"–¢–∏–ø 10: –º–∏–∫—Ä–æ–º–µ—Ç–∫–∞ –Ω–∞ –ª–±—É (–æ—á–µ–Ω—å –º–∞–ª–µ–Ω—å–∫–∏–π —Ä–æ–º–± —á—É—Ç—å –Ω–∏–∂–µ –≤–µ—Ä—Ö–∞)." },
  ];

  // ---------- DOM ----------
  const overlay = document.getElementById('overlay');
  const btnStart = document.getElementById('btnStart');

  const enemyEl = document.getElementById('enemy');
  const enemyArt = document.getElementById('enemyArt');

  const typeSelect = document.getElementById('typeSelect');
  const noteInput = document.getElementById('note');

  const btnSubmit = document.getElementById('btnSubmit');
  const btnReset = document.getElementById('btnReset');
  const btnPause = document.getElementById('btnPause');

  const alarmTitle = document.getElementById('alarmTitle');
  const alarmSub = document.getElementById('alarmSub');
  const remainEl = document.getElementById('remain');
  const barEl = document.getElementById('bar');
  const hintEl = document.getElementById('hint');

  const dotState = document.getElementById('dotState');
  const stateLabel = document.getElementById('stateLabel');

  const survivalEl = document.getElementById('survival');
  const streakEl = document.getElementById('streak');

  const logEl = document.getElementById('log');
  const toast = document.getElementById('toast');
  const toastText = document.getElementById('toastText');

  const codexGrid = document.getElementById('codexGrid');

  function setState(kind, label){
    stateLabel.textContent = label;
    dotState.classList.remove('ok','bad','pause');
    if(kind === 'ok') dotState.classList.add('ok');
    if(kind === 'bad') dotState.classList.add('bad');
    if(kind === 'pause') dotState.classList.add('pause');
  }
  function showToast(text){
    toastText.textContent = text;
    toast.classList.add('show');
    clearTimeout(showToast._t);
    showToast._t = setTimeout(()=>toast.classList.remove('show'), 2200);
  }
  function addLog({ok, realTypeLabel, reportedLabel, timeStr, note}){
    const div = document.createElement('div');
    div.className = 'entry';
    div.innerHTML = `
      <div class="entryTop">
        <span>${escapeHtml(timeStr)}</span>
        <span class="pill ${ok ? 'ok':'bad'}">${ok ? '–£–°–ü–ï–•' : '–ü–û–†–ê–ñ–ï–ù–ò–ï'}</span>
      </div>
      <div><b>–í—Ä–∞–≥:</b> ${escapeHtml(realTypeLabel)}</div>
      <div><b>–û—Ç—á—ë—Ç:</b> ${escapeHtml(reportedLabel ?? '‚Äî')} ${note ? `<span class="muted">(${escapeHtml(note)})</span>`:''}</div>
    `;
    logEl.prepend(div);
  }

  // Fill select + codex (TYPE NUMBERS are here = instruction)
  ENEMIES.forEach((e, idx)=>{
    const opt = document.createElement('option');
    opt.value = e.id;
    opt.textContent = `${idx+1}. ${e.label}`;
    typeSelect.appendChild(opt);
  });

  ENEMIES.forEach((e, idx)=>{
    const item = document.createElement('div');
    item.className = 'codexItem';
    item.innerHTML = `
      <div class="codexArt">${e.art}</div>
      <div>
        <div class="codexName">–¢–∏–ø ${idx+1}</div>
        <div class="codexText">${escapeHtml(e.tell)}</div>
      </div>
    `;
    codexGrid.appendChild(item);
  });

  // ---------- Game state (dt-based) ----------
  const GAME = {
    started:false,
    running:false,
    paused:false,
    hiddenPause:false,

    survivalMs: 0,
    streak: 0,

    waveActive:false,
    waveRemainingMs: 0,
    horned:false,
    reportedType:null,
    currentEnemy:null,

    spawnRemainingMs: 0
  };

  function scheduleNextSpawn(){
    GAME.spawnRemainingMs = rndInt(30_000, 180_000);
  }

  function resetUIToIdle(){
    enemyEl.classList.remove('active');
    enemyArt.innerHTML = '';

    alarmTitle.textContent = '–¢–∏—à–∏–Ω–∞ –Ω–∞ —Ç—Ä–∞–∫—Ç–µ';
    alarmSub.textContent = '–í—Ä–µ–º—è –¥–æ –ø–æ—è–≤–ª–µ–Ω–∏—è —Å–∫—Ä—ã—Ç–æ.';
    hintEl.textContent = '–ñ–¥–∏ –∫–æ–Ω—Ç–∞–∫—Ç–∞';
    remainEl.textContent = '‚Äî';
    barEl.style.width = '0%';

    setState('ok','–¢–∏—à–∏–Ω–∞');
  }

  function resetGame(){
    GAME.running = true;
    GAME.paused = false;
    GAME.hiddenPause = document.hidden;

    GAME.survivalMs = 0;
    GAME.streak = 0;
    streakEl.textContent = '0';

    GAME.waveActive = false;
    GAME.waveRemainingMs = 0;
    GAME.horned = false;
    GAME.reportedType = null;
    GAME.currentEnemy = null;

    logEl.innerHTML = '';
    noteInput.value = '';
    typeSelect.selectedIndex = 0;

    resetUIToIdle();
    audio.setFootsteps(false);
    audio.setIntensity(1.0);

    scheduleNextSpawn();
    showToast('–ü–æ—Å—Ç –Ω–∞—á–∞—Ç.');
  }

  function startWave(){
    GAME.waveActive = true;
    GAME.waveRemainingMs = 20_000;
    GAME.horned = false;
    GAME.reportedType = null;

    GAME.currentEnemy = pick(ENEMIES);
    enemyArt.innerHTML = GAME.currentEnemy.art;

    enemyEl.classList.remove('active');
    void enemyEl.offsetWidth;
    enemyEl.classList.add('active');

    alarmTitle.textContent = '–¢—Ä–µ–≤–æ–≥–∞!';
    alarmSub.textContent = '–ó–∞ 20 —Å–µ–∫—É–Ω–¥: –≤—ã–±—Ä–∞—Ç—å —Ç–∏–ø ‚Üí ¬´–ü–æ–¥–∞—Ç—å –æ—Ç—á—ë—Ç¬ª ‚Üí –ü–†–û–ë–ï–õ (–≥–æ—Ä–Ω).';
    hintEl.textContent = '–°–Ω–∞—á–∞–ª–∞ –æ—Ç—á—ë—Ç, –ø–æ—Ç–æ–º –≥–æ—Ä–Ω.';
    setState('bad','–¢—Ä–µ–≤–æ–≥–∞');

    audio.setFootsteps(true); // quiet steps
    showToast('–ö–æ–Ω—Ç–∞–∫—Ç. –°–º–æ—Ç—Ä–∏ —Å–∏–ª—É—ç—Ç.');
    pulse(1.15);
  }

  function endWave(ok, reason){
    const timeStr = `‚è±Ô∏è ${fmtTime(GAME.survivalMs)}`;
    const realIdx = GAME.currentEnemy ? ENEMIES.findIndex(x=>x.id === GAME.currentEnemy.id) : -1;
    const repIdx  = GAME.reportedType ? ENEMIES.findIndex(x=>x.id === GAME.reportedType) : -1;

    const realLabel = realIdx >= 0 ? `–¢–∏–ø ${realIdx+1}` : '‚Äî';
    const repLabel  = repIdx  >= 0 ? `–¢–∏–ø ${repIdx+1}`  : null;

    addLog({
      ok,
      realTypeLabel: realLabel,
      reportedLabel: repLabel,
      timeStr,
      note: noteInput.value.trim()
    });

    enemyEl.classList.remove('active');
    enemyArt.innerHTML = '';
    audio.setFootsteps(false);

    GAME.waveActive = false;
    GAME.currentEnemy = null;
    GAME.reportedType = null;
    GAME.horned = false;
    GAME.waveRemainingMs = 0;

    remainEl.textContent = '‚Äî';
    barEl.style.width = '0%';

    if(ok){
      GAME.streak++;
      streakEl.textContent = String(GAME.streak);
      resetUIToIdle();
      showToast(`–£—Å–ø–µ—Ö: ${reason}`);
      scheduleNextSpawn();
    } else {
      GAME.running = false;
      alarmTitle.textContent = '–ü–û–†–ê–ñ–ï–ù–ò–ï';
      alarmSub.textContent = `${reason} –ù–∞–∂–º–∏ ¬´–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫¬ª.`;
      hintEl.textContent = '–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏ –∏–≥—Ä—É.';
      setState('bad','–ü—Ä–æ–≤–∞–ª');
      showToast('–ü—Ä–æ–≤–∞–ª.');
      pulse(1.6);
    }
  }

  function validateAndFinishByHorn(){
    if(!GAME.reportedType) return endWave(false, '–ì–æ—Ä–Ω –±–µ–∑ –æ—Ç—á—ë—Ç–∞.');
    if(!GAME.currentEnemy || GAME.reportedType !== GAME.currentEnemy.id) return endWave(false, '–ù–µ–≤–µ—Ä–Ω—ã–π —Ç–∏–ø –≤ –æ—Ç—á—ë—Ç–µ.');
    return endWave(true, '–¢—Ä–µ–≤–æ–≥–∞ –∑–∞–∫—Ä—ã—Ç–∞ –≤–µ—Ä–Ω–æ.');
  }

  function togglePause(){
    if(!GAME.started) return;
    if(!GAME.running){ showToast('–ü–æ—Ä–∞–∂–µ–Ω–∏–µ. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏.'); return; }

    GAME.paused = !GAME.paused;
    if(GAME.paused){
      audio.setFootsteps(false);
      audio.setIntensity(0.25);
      setState('pause','–ü–∞—É–∑–∞');
      alarmSub.textContent = '–ü–∞—É–∑–∞: –≤—Ä–µ–º—è –Ω–µ –∏–¥—ë—Ç.';
      hintEl.textContent = '–ü–∞—É–∑–∞ –≤–∫–ª—é—á–µ–Ω–∞.';
      showToast('–ü–∞—É–∑–∞.');
    } else {
      audio.setIntensity(1.0);
      if(GAME.waveActive) audio.setFootsteps(true);
      setState(GAME.waveActive ? 'bad' : 'ok', GAME.waveActive ? '–¢—Ä–µ–≤–æ–≥–∞' : '–¢–∏—à–∏–Ω–∞');
      alarmSub.textContent = GAME.waveActive ? '–ó–∞ 20 —Å–µ–∫—É–Ω–¥: –≤—ã–±—Ä–∞—Ç—å —Ç–∏–ø ‚Üí ¬´–ü–æ–¥–∞—Ç—å –æ—Ç—á—ë—Ç¬ª ‚Üí –ü–†–û–ë–ï–õ (–≥–æ—Ä–Ω).' : '–í—Ä–µ–º—è –¥–æ –ø–æ—è–≤–ª–µ–Ω–∏—è —Å–∫—Ä—ã—Ç–æ.';
      hintEl.textContent = GAME.waveActive ? '–°–Ω–∞—á–∞–ª–∞ –æ—Ç—á—ë—Ç, –ø–æ—Ç–æ–º –≥–æ—Ä–Ω.' : '–ñ–¥–∏ –∫–æ–Ω—Ç–∞–∫—Ç–∞';
      showToast('–ü—Ä–æ–¥–æ–ª–∂–∞–µ–º.');
    }
  }

  // Controls
  btnSubmit.addEventListener('click', () => {
    if(!GAME.started) return;
    if(!GAME.running){ showToast('–ü–æ—Ä–∞–∂–µ–Ω–∏–µ. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏.'); return; }
    if(GAME.paused || GAME.hiddenPause){ showToast('–ü–∞—É–∑–∞.'); return; }
    if(!GAME.waveActive){ showToast('–¢—Ä–µ–≤–æ–≥–∏ –Ω–µ—Ç.'); return; }

    if(GAME.waveRemainingMs <= 0) return endWave(false, '–û—Ç—á—ë—Ç —Å–ª–∏—à–∫–æ–º –ø–æ–∑–¥–Ω–æ.');
    GAME.reportedType = typeSelect.value;
    hintEl.textContent = '–û—Ç—á—ë—Ç –ø—Ä–∏–Ω—è—Ç. –¢–µ–ø–µ—Ä—å –ü–†–û–ë–ï–õ.';
    showToast('–û—Ç—á—ë—Ç –ø—Ä–∏–Ω—è—Ç.');
  });

  btnReset.addEventListener('click', () => {
    if(!GAME.started) return;
    resetGame();
  });

  btnPause.addEventListener('click', togglePause);

  window.addEventListener('keydown', (e) => {
    if(e.code === 'KeyP'){
      e.preventDefault();
      togglePause();
      return;
    }
    if(e.code !== 'Space') return;
    e.preventDefault();

    if(!GAME.started) return;
    if(!GAME.running){ showToast('–ü–æ—Ä–∞–∂–µ–Ω–∏–µ. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏.'); return; }
    if(GAME.paused || GAME.hiddenPause){ showToast('–ü–∞—É–∑–∞.'); return; }

    // horn always plays, but rules decide win/lose
    audio.horn();
    pulse(1.25);

    if(!GAME.waveActive) return endWave(false, '–ì–æ—Ä–Ω –±–µ–∑ —Ç—Ä–µ–≤–æ–≥–∏.');
    if(GAME.waveRemainingMs <= 0) return endWave(false, '–ì–æ—Ä–Ω —Å–ª–∏—à–∫–æ–º –ø–æ–∑–¥–Ω–æ.');

    GAME.horned = true;
    validateAndFinishByHorn();
  });

  // Stop time when tab hidden
  document.addEventListener('visibilitychange', () => {
    GAME.hiddenPause = document.hidden;
    if(GAME.hiddenPause){
      audio.setFootsteps(false);
      audio.setIntensity(0.20);
      if(GAME.running){
        setState('pause','–ü–∞—É–∑–∞');
        alarmSub.textContent = '–ü–∞—É–∑–∞: –≤–∫–ª–∞–¥–∫–∞ –Ω–µ –∞–∫—Ç–∏–≤–Ω–∞. –í—Ä–µ–º—è –Ω–µ –∏–¥—ë—Ç.';
        hintEl.textContent = '–í–µ—Ä–Ω–∏—Å—å –≤–æ –≤–∫–ª–∞–¥–∫—É.';
      }
    } else {
      audio.setIntensity(GAME.paused ? 0.25 : 1.0);
      if(!GAME.paused && GAME.running){
        setState(GAME.waveActive ? 'bad' : 'ok', GAME.waveActive ? '–¢—Ä–µ–≤–æ–≥–∞' : '–¢–∏—à–∏–Ω–∞');
        alarmSub.textContent = GAME.waveActive ? '–ó–∞ 20 —Å–µ–∫—É–Ω–¥: –≤—ã–±—Ä–∞—Ç—å —Ç–∏–ø ‚Üí ¬´–ü–æ–¥–∞—Ç—å –æ—Ç—á—ë—Ç¬ª ‚Üí –ü–†–û–ë–ï–õ (–≥–æ—Ä–Ω).' : '–í—Ä–µ–º—è –¥–æ –ø–æ—è–≤–ª–µ–Ω–∏—è —Å–∫—Ä—ã—Ç–æ.';
        hintEl.textContent = GAME.waveActive ? '–°–Ω–∞—á–∞–ª–∞ –æ—Ç—á—ë—Ç, –ø–æ—Ç–æ–º –≥–æ—Ä–Ω.' : '–ñ–¥–∏ –∫–æ–Ω—Ç–∞–∫—Ç–∞';
        if(GAME.waveActive) audio.setFootsteps(true);
      }
    }
  });

  // Main loop (no spawn hint)
  let last = performance.now();
  function loop(ts){
    const dt = Math.min(60, ts - last);
    last = ts;

    const timeFlows = GAME.started && GAME.running && !GAME.paused && !GAME.hiddenPause;

    if(timeFlows){
      GAME.survivalMs += dt;

      if(!GAME.waveActive){
        GAME.spawnRemainingMs -= dt;
        remainEl.textContent = '‚Äî';
        barEl.style.width = '0%';
        if(GAME.spawnRemainingMs <= 0) startWave();
      } else {
        GAME.waveRemainingMs -= dt;
        remainEl.textContent = fmtTime(GAME.waveRemainingMs);
        const p = clamp(1 - (GAME.waveRemainingMs / 20_000), 0, 1);
        barEl.style.width = (p * 100).toFixed(1) + '%';

        if(GAME.waveRemainingMs <= 0){
          // if any step missing or wrong -> lose
          if(!GAME.reportedType) endWave(false, '–í—Ä–µ–º—è –≤—ã—à–ª–æ: –æ—Ç—á—ë—Ç –Ω–µ –ø–æ–¥–∞–Ω.');
          else if(GAME.reportedType !== GAME.currentEnemy.id) endWave(false, '–í—Ä–µ–º—è –≤—ã—à–ª–æ: –æ—Ç—á—ë—Ç –Ω–µ–≤–µ—Ä–Ω—ã–π.');
          else if(!GAME.horned) endWave(false, '–í—Ä–µ–º—è –≤—ã—à–ª–æ: –≥–æ—Ä–Ω –Ω–µ –ø—Ä–æ–∑–≤—É—á–∞–ª.');
          else endWave(true, '–ó–∞–∫—Ä—ã—Ç–æ –≤–æ–≤—Ä–µ–º—è.');
        }
      }
    }

    if(GAME.started){
      survivalEl.textContent = fmtTime(GAME.survivalMs);
    }
    requestAnimationFrame(loop);
  }

  // Start
  btnStart.addEventListener('click', async () => {
    await audio.start(); // required user gesture
    overlay.style.display = 'none';

    GAME.started = true;
    resetGame();
    requestAnimationFrame(loop);
  });
})();
</script>
</body>
</html>
